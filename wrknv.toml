# Python Library wrknv.toml Template
# Canonical task configuration for Python library projects in the provide.io ecosystem
# This file is maintained in provide-foundry and can be extracted to library projects
#
# Source: provide-foundry/src/provide/foundry/config/wrknv.python.tmpl
# To update: run extraction function from provide-foundry
#
# Usage:
#   we tasks              # List all available tasks
#   we <task>             # Run a task (e.g., we test, we lint)
#   we run <task>         # Explicit run command
#   we run <task> --info  # Show task details

# ==============================================================================
# ðŸ§ª Testing
# ==============================================================================

[tasks.test]
_default = "pytest"
parallel = "pytest -n auto"
verbose = "pytest -vvv"
unit = "pytest -m unit"
integration = "pytest -m integration"

[tasks.test.coverage]
_default = "pytest --cov=src --cov-report=html --cov-report=term-missing"
xml = "pytest --cov=src --cov-report=xml --cov-report=term"

# ==============================================================================
# ðŸ§¬ Mutation Testing
# ==============================================================================

[tasks.mutation]
_default = "mutmut run"
results = "mutmut results"
browse = "mutmut browse"
clean = "rm -rf .mutmut-cache html/"

# ==============================================================================
# ðŸ” Code Quality
# ==============================================================================

[tasks.lint]
_default = "ruff check ."
fix = "ruff check . --fix"

[tasks.format]
_default = "ruff format ."
check = "ruff format . --check"

[tasks.quality]
_default = ["lint", "typecheck"]
all = ["format.check", "lint", "typecheck", "test"]

# ==============================================================================
# ðŸ—ï¸ Build & Package
# ==============================================================================

[tasks.pkg]
install = "uv pip install -e ."
uninstall = "uv pip uninstall -y $(grep '^name = ' pyproject.toml | cut -d'\"' -f2)"
lock = "uv lock"

# ==============================================================================
# ðŸ§¹ Clean
# ==============================================================================

[tasks.clean]
run = """
rm -rf build/ dist/ *.egg-info .pytest_cache .mypy_cache .ruff_cache .hypothesis htmlcov/ .coverage .mutmut-cache site/
find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
find . -type f -name '*.pyc' -delete 2>/dev/null || true
find . -type f -name '*.pyo' -delete 2>/dev/null || true
"""

# ==============================================================================
# ðŸ“š Documentation
# ==============================================================================

[tasks.docs]
_default = "mkdocs serve"
setup = "python -c \"from provide.foundry.config import extract_base_mkdocs; from pathlib import Path; extract_base_mkdocs(Path('.'))\""
build = "mkdocs build"
clean = "rm -rf site site-markdown .provide .markdown-export.cache"

[tasks.docs.serve]
run = "mkdocs serve"
timeout = 604800.0  # 1 week - effectively no timeout for development server

[tasks.docs.build-markdown]
_default = "sh -c 'DOCS_FORMAT=markdown DOCS_MARKDOWN_ENABLED=true mkdocs build'"
no-api = "sh -c 'DOCS_FORMAT=markdown DOCS_MARKDOWN_ENABLED=true DOCS_INCLUDE_API=false mkdocs build'"
collapsed = "sh -c 'DOCS_FORMAT=markdown DOCS_MARKDOWN_ENABLED=true DOCS_STRUCTURE=collapsed mkdocs build'"
collapsed-no-api = "sh -c 'DOCS_FORMAT=markdown DOCS_MARKDOWN_ENABLED=true DOCS_STRUCTURE=collapsed DOCS_INCLUDE_API=false mkdocs build'"
single-file = "sh -c 'DOCS_FORMAT=markdown DOCS_MARKDOWN_ENABLED=true DOCS_SINGLE_FILE=true mkdocs build'"
full = "sh -c 'DOCS_FORMAT=markdown DOCS_MARKDOWN_ENABLED=true DOCS_INCLUDE_API=false DOCS_SINGLE_FILE=true mkdocs build'"

[tasks.docs.build-both]
_default = "sh -c 'DOCS_FORMAT=both DOCS_MARKDOWN_ENABLED=true mkdocs build'"

[tasks.docs.links]
_default = "lychee --offline --verbose --no-progress './docs/**/*.md' './src/**/*.md' './README.md' './.github/**/*.md' './CONTRIBUTING.md' 2>&1 | grep -v 'INFO'"
check = "lychee --offline --verbose --no-progress './docs/**/*.md' './src/**/*.md' './README.md' './.github/**/*.md' './CONTRIBUTING.md' 2>&1 | grep -v 'INFO'"
local = "lychee --offline --verbose --no-progress './docs/**/*.md' './src/**/*.md' './README.md' './.github/**/*.md' './CONTRIBUTING.md' 2>&1 | grep -v 'INFO'"
external = "lychee --verbose --no-progress './docs/**/*.md' './src/**/*.md' './README.md' './.github/**/*.md' './CONTRIBUTING.md'"
fix = "python -m provide.foundry.docs docs/ --verbose"
fix-all = "python -m provide.foundry.docs docs/ ../ci-tooling/docs/ ../flavorpack/docs/ ../plating/docs/ ../supsrc/docs/ ../wrknv/docs/ ../pyvider/docs/ ../pyvider-cty/docs/ ../pyvider-hcl/docs/ ../pyvider-rpcplugin/docs/ ../pyvider-components/docs/ ../tofusoup/docs/ ../provide-foundation/docs/ ../provide-testkit/docs/ ../terraform-provider-pyvider/docs/ ../terraform-provider-tofusoup/docs/ --verbose"
check-format = "python -m provide.foundry.docs docs/ --dry-run"

# ==============================================================================
# ðŸš€ Development Workflow Shortcuts
# ==============================================================================

[tasks.dev]
setup = "uv sync"
test = "pytest -n auto"
check = "ruff format . && ruff check . && mypy src/"

# ==============================================================================
# ðŸ¤– CI/CD Pipelines
# ==============================================================================

[tasks.ci]
_default = ["quality", "test", "build"]
test = ["test.parallel", "test.coverage"]
quality = ["format.check", "lint", "typecheck"]

# ==============================================================================
# Simple Top-Level Tasks
# ==============================================================================

[tasks]
typecheck = "mypy src/"
build = "uv build"
setup = "uv sync"
